# WebSocket åŒå‘å¿ƒè·³æœºåˆ¶è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†**åŒå‘å¿ƒè·³æœºåˆ¶**ï¼Œç¡®ä¿ WebSocket è¿æ¥çš„ç¨³å®šæ€§ï¼ŒåŠæ—¶æ£€æµ‹å’Œæ¸…ç†åƒµå°¸è¿æ¥ã€‚

---

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (æµè§ˆå™¨)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ å®¢æˆ·ç«¯å¿ƒè·³   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  æœåŠ¡å™¨      â”‚                   â”‚
â”‚  â”‚ (15ç§’é—´éš”)   â”‚   ping   â”‚  å“åº” pong  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â–²                       â”‚                           â”‚
â”‚         â”‚ pong                  â”‚ ping                      â”‚
â”‚         â”‚                       â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ å“åº” pong   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ æœåŠ¡å™¨å¿ƒè·³   â”‚                   â”‚
â”‚  â”‚ (20ç§’è¶…æ—¶)   â”‚         â”‚ (15ç§’é—´éš”)   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®å‚æ•°

### å‰ç«¯é…ç½® (`src/core/ws.ts`)

```typescript
const WS_CONFIG = {
  // å¿ƒè·³é—´éš”ï¼ˆå®¢æˆ·ç«¯å‘é€ï¼‰
  heartbeatInterval: 15000,   // 15 ç§’

  // pong è¶…æ—¶æ—¶é—´ï¼ˆç­‰å¾…æœåŠ¡å™¨å“åº”ï¼‰
  pongTimeout: 20000,         // 20 ç§’ï¼ˆå¿ƒè·³é—´éš” + 5ç§’ç¼“å†²ï¼‰

  // é‡è¿é…ç½®
  reconnectInterval: 2000,    // 2 ç§’
  maxReconnectAttempts: 10,   // æœ€å¤šé‡è¿ 10 æ¬¡
};
```

### åç«¯é…ç½® (`src/ui/web_server.py`)

```python
# æœåŠ¡å™¨å¿ƒè·³é…ç½®
heartbeat_interval = 15.0    # 15 ç§’
pong_timeout = 20.0          # 20 ç§’
```

---

## å·¥ä½œæµç¨‹

### 1. å®¢æˆ·ç«¯å¿ƒè·³ï¼ˆå‰ç«¯ â†’ åç«¯ï¼‰

**æµç¨‹**ï¼š
```
1. æ¯ 15 ç§’ï¼Œå‰ç«¯å‘é€ ping
2. ç­‰å¾…åç«¯å“åº” pong
3. å¦‚æœ 20 ç§’å†…æœªæ”¶åˆ° pongï¼Œè§¦å‘è¶…æ—¶å¤„ç†
4. è‡ªåŠ¨å…³é—­è¿æ¥å¹¶è§¦å‘é‡è¿
```

**ä»£ç ä½ç½®**ï¼š`src/core/ws.ts`

```typescript
private sendHeartbeat(): void {
  if (this.ws && this.ws.readyState === WebSocket.OPEN) {
    this.ws.send(JSON.stringify({ type: "ping" }));
    this.startPongTimer(); // å¯åŠ¨ 20 ç§’è¶…æ—¶æ£€æµ‹
  }
}

// æ”¶åˆ° pong æ—¶
private handleMessage(event: EngineEvent): void {
  if (event.type === "pong") {
    this.clearPongTimer(); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
    return;
  }
}
```

### 2. æœåŠ¡å™¨å¿ƒè·³ï¼ˆåç«¯ â†’ å‰ç«¯ï¼‰

**æµç¨‹**ï¼š
```
1. æ¯ 15 ç§’ï¼Œåç«¯å‘é€ ping
2. ç­‰å¾…å‰ç«¯å“åº” pong
3. å¦‚æœ 20 ç§’å†…æœªæ”¶åˆ° pongï¼Œä¸»åŠ¨å…³é—­è¿æ¥
4. å‰ç«¯æ£€æµ‹åˆ°æ–­å¼€åè‡ªåŠ¨é‡è¿
```

**ä»£ç ä½ç½®**ï¼š`src/ui/web_server.py`

```python
async def server_heartbeat_task():
    heartbeat_interval = 15.0
    pong_timeout = 20.0

    while websocket.client_state.name == 'CONNECTED':
        await asyncio.sleep(heartbeat_interval)

        # å‘é€ ping
        await websocket.send_text(json.dumps({"type": "ping"}))

        # ç­‰å¾… pong
        start_time = asyncio.get_event_loop().time()
        pong_received = False

        while (asyncio.get_event_loop().time() - start_time) < pong_timeout:
            try:
                message = await asyncio.wait_for(websocket.receive_text(), timeout=1.0)
                data = json.loads(message)

                if data.get("type") == "pong":
                    pong_received = True
                    break
            except asyncio.TimeoutError:
                continue

        if not pong_received:
            await websocket.close(code=1000, reason="Heartbeat timeout")
```

---

## è¶…æ—¶å¤„ç†æœºåˆ¶

### å‰ç«¯è¶…æ—¶å¤„ç†

```typescript
private handleHeartbeatFailure(): void {
  console.error("[WS] Heartbeat failed, closing connection");
  this.stopHeartbeat();

  // å…³é—­è¿æ¥
  if (this.ws && this.ws.readyState === WebSocket.OPEN) {
    this.ws.close(1000, "Heartbeat timeout");
  }

  // è‡ªåŠ¨é‡è¿
  this.scheduleReconnect();
}
```

### åç«¯è¶…æ—¶å¤„ç†

```python
if not pong_received:
    logger.error("Server pong timeout - closing connection")
    await websocket.close(code=1000, reason="Heartbeat timeout")
```

---

## æ¶ˆæ¯æ ¼å¼

### Ping æ¶ˆæ¯ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "ping"
}
```

### Pong æ¶ˆæ¯ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "pong"
}
```

---

## æ—¥å¿—è¾“å‡º

### å‰ç«¯æ—¥å¿—

```
[WS] Connected to server
[WS] Sent ping to server
[WS] Received pong - connection is alive
[WS] Received ping from server, sending pong
```

### åç«¯æ—¥å¿—

```
ğŸ’“ [WS] Server heartbeat started (interval: 15s, timeout: 20s)
ğŸ’“ [WS] Server ping sent
ğŸ’“ [WS] Server pong received
âŒ [WS] Server pong timeout - closing connection
```

---

## ä¼˜åŠ¿

### 1. åŒå‘æ£€æµ‹
- å‰ç«¯æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å­˜æ´»
- åç«¯æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦å­˜æ´»
- åŠæ—¶å‘ç°ç½‘ç»œé—®é¢˜

### 2. é˜²æ­¢åƒµå°¸è¿æ¥
- è‡ªåŠ¨æ¸…ç†æ— å“åº”çš„è¿æ¥
- é‡Šæ”¾æœåŠ¡å™¨èµ„æº
- é¿å…æ¶ˆæ¯å‘é€åˆ°æ–­å¼€çš„è¿æ¥

### 3. å¿«é€Ÿæ•…éšœæ¢å¤
- è¶…æ—¶åè‡ªåŠ¨é‡è¿
- æœ€å°åŒ–æœåŠ¡ä¸­æ–­æ—¶é—´
- æé«˜ç³»ç»Ÿå¯ç”¨æ€§

### 4. çµæ´»é…ç½®
- å¯è°ƒæ•´å¿ƒè·³é—´éš”
- å¯è°ƒæ•´è¶…æ—¶æ—¶é—´
- é€‚åº”ä¸åŒç½‘ç»œç¯å¢ƒ

---

## æµ‹è¯•ä¸éªŒè¯

### 1. æŸ¥çœ‹å¿ƒè·³æ—¥å¿—

**å‰ç«¯**ï¼š
```
[WS] Sent ping to server
[WS] Received pong - connection is alive
```

**åç«¯**ï¼š
```
ğŸ’“ [WS] Server ping sent
ğŸ’“ [WS] Server pong received
```

### 2. æµ‹è¯•è¶…æ—¶é‡è¿

**æ–¹æ³•**ï¼š
1. å¯åŠ¨å‰ç«¯å’Œåç«¯
2. è§‚å¯Ÿæ­£å¸¸å¿ƒè·³æ—¥å¿—
3. æ‹”æ‰ç½‘çº¿æˆ–æ–­å¼€ç½‘ç»œ
4. ç­‰å¾…è¶…æ—¶ï¼ˆ20 ç§’ï¼‰
5. è§‚å¯Ÿé‡è¿æ—¥å¿—

**é¢„æœŸç»“æœ**ï¼š
```
[WS] Pong timeout - connection may be dead
[WS] Reconnecting in 2000ms (attempt 1/10)
[WS] Connected to server
```

### 3. ç›‘æ§è¿æ¥çŠ¶æ€

ä½¿ç”¨æµè§ˆå™¨ DevTools æŸ¥çœ‹ WebSocket è¿æ¥çŠ¶æ€ï¼š
- è¿æ¥å»ºç«‹ï¼šState = `OPEN`
- å¿ƒè·³å‘é€ï¼šFrames ä¸­æœ‰ `{"type":"ping"}`
- å¿ƒè·³å“åº”ï¼šFrames ä¸­æœ‰ `{"type":"pong"}`

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå¿ƒè·³é—´éš”æ˜¯ 15 ç§’ï¼Ÿ

**A**: å¹³è¡¡äº†ç½‘ç»œè´Ÿè½½å’Œæ•…éšœæ£€æµ‹é€Ÿåº¦ï¼š
- 30 ç§’å¤ªæ…¢ï¼Œæ•…éšœå‘ç°å»¶è¿Ÿé•¿
- 5 ç§’å¤ªå¿«ï¼Œå¢åŠ ç½‘ç»œè´Ÿè½½
- 15 ç§’æ˜¯è¾ƒå¥½çš„æŠ˜ä¸­

### Q2: ä¸ºä»€ä¹ˆè¶…æ—¶æ—¶é—´æ˜¯ 20 ç§’ï¼Ÿ

**A**: è¶…æ—¶æ—¶é—´ = å¿ƒè·³é—´éš” + ç¼“å†²æ—¶é—´
- 15 ç§’å¿ƒè·³ + 5 ç§’ç¼“å†² = 20 ç§’
- 5 ç§’ç¼“å†²è€ƒè™‘äº†ç½‘ç»œå»¶è¿Ÿå’ŒæŠ–åŠ¨

### Q3: å¿ƒè·³å¤±è´¥åå¤šä¹…é‡è¿ï¼Ÿ

**A**:
- é»˜è®¤ 2 ç§’åå¼€å§‹é‡è¿
- é‡è¿é—´éš”æŒ‡æ•°é€€é¿ï¼š2s, 4s, 8s, ...
- æœ€å¤šé‡è¿ 10 æ¬¡

### Q4: æ˜¯å¦å¯ä»¥å…³é—­å¿ƒè·³ï¼Ÿ

**A**: ä¸å»ºè®®å…³é—­ï¼å¿ƒè·³æœºåˆ¶æ˜¯è¿æ¥ç¨³å®šæ€§çš„é‡è¦ä¿éšœã€‚

---

## æ€§èƒ½å½±å“

### ç½‘ç»œæµé‡
- æ¯ä¸ªè¿æ¥æ¯ 15 ç§’å‘é€ 2 æ¡æ¶ˆæ¯ï¼ˆping + pongï¼‰
- æ¶ˆæ¯å¤§å°çº¦ 20 å­—èŠ‚
- å•ä¸ªè¿æ¥å¸¦å®½å ç”¨ï¼š~26.7 å­—èŠ‚/ç§’

### CPU å ç”¨
- å‰ç«¯ï¼šå‡ ä¹æ—  CPU å ç”¨ï¼ˆå®šæ—¶å™¨ + æ¶ˆæ¯å‘é€ï¼‰
- åç«¯ï¼šæ¯ä¸ªè¿æ¥ä¸€ä¸ªè½»é‡çº§ä»»åŠ¡ï¼ŒCPU å ç”¨å¯å¿½ç•¥

### å†…å­˜å ç”¨
- å‰ç«¯ï¼šæ¯ä¸ªå®šæ—¶å™¨çº¦ 50 å­—èŠ‚
- åç«¯ï¼šæ¯ä¸ªå¿ƒè·³ä»»åŠ¡çº¦ 1KB
- 1000 ä¸ªè¿æ¥çº¦ 1MB å†…å­˜å ç”¨

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **è‡ªé€‚åº”å¿ƒè·³é—´éš”**ï¼šæ ¹æ®ç½‘ç»œè´¨é‡åŠ¨æ€è°ƒæ•´
2. **å¿ƒè·³æ•°æ®æ ¡éªŒ**ï¼šå‘é€æ—¶é—´æˆ³ï¼Œè®¡ç®—å¾€è¿”å»¶è¿Ÿ
3. **æ‰¹é‡å¿ƒè·³**ï¼šå¤šä¸ªè¿æ¥å…±äº«å¿ƒè·³æ£€æµ‹
4. **å¿ƒè·³ç»Ÿè®¡**ï¼šè®°å½•æˆåŠŸç‡ã€å¹³å‡å»¶è¿Ÿç­‰æŒ‡æ ‡

---

## å‚è€ƒèµ„æ–™

- [WebSocket RFC 6455](https://tools.ietf.org/html/rfc6455)
- [FastAPI WebSocket æ–‡æ¡£](https://fastapi.tiangolo.com/advanced/websockets/)
- [WebSocket å¿ƒè·³æœ€ä½³å®è·µ](https://www.npmjs.com/package/@stomp/stompjs#heartbeat)
